#!/usr/bin/env bash
# update-all — update every package manager and tool in one shot

BOLD='\033[1m'
CYAN='\033[1;36m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
GREEN='\033[1;32m'
RESET='\033[0m'

failures=()

section() {
    echo -e "\n${CYAN}${BOLD}:: $1${RESET}\n"
}

skip() {
    echo -e "${YELLOW}   $1 not found, skipping${RESET}"
}

# ── DNF ──────────────────────────────────────────────────────────────
section "DNF"
if command -v dnf &>/dev/null; then
    sudo dnf upgrade -y --refresh --offline || failures+=("DNF")
else
    skip "dnf"
fi

# ── Flatpak ──────────────────────────────────────────────────────────
section "Flatpak"
if command -v flatpak &>/dev/null; then
    flatpak update -y || failures+=("Flatpak")
else
    skip "flatpak"
fi

# ── Homebrew ─────────────────────────────────────────────────────────
section "Homebrew"
if command -v brew &>/dev/null; then
    brew update && brew upgrade || failures+=("Homebrew")
else
    skip "brew"
fi

# ── Oh My Zsh ────────────────────────────────────────────────────────
section "Oh My Zsh"
if [[ -f "${ZSH:-$HOME/.oh-my-zsh}/tools/upgrade.sh" ]]; then
    bash "${ZSH:-$HOME/.oh-my-zsh}/tools/upgrade.sh" || failures+=("Oh My Zsh")
else
    skip "oh-my-zsh"
fi

# ── .NET tools ─────────────────────────────────────────────────────
section ".NET tools"
if command -v dotnet &>/dev/null; then
    while read -r tool; do
        dotnet tool update -g "$tool" || failures+=(".NET tool: $tool")
    done < <(dotnet tool list -g | tail -n +3 | awk '{print $1}')
else
    skip "dotnet"
fi

# ── Neovim plugins ──────────────────────────────────────────────────
section "Neovim plugins"
if command -v nvim &>/dev/null; then
    nvim --headless "+Lazy! sync" +qa || failures+=("Neovim plugins")
else
    skip "nvim"
fi

# ── Cleanup ──────────────────────────────────────────────────────────
section "Cleanup"
if command -v dnf &>/dev/null; then
    sudo dnf autoremove -y || failures+=("DNF cleanup")
fi
if command -v flatpak &>/dev/null; then
    flatpak uninstall --unused -y || failures+=("Flatpak cleanup")
fi

# ── Summary ──────────────────────────────────────────────────────────
echo ""
if [[ ${#failures[@]} -eq 0 ]]; then
    echo -e "${GREEN}${BOLD}All updates completed successfully.${RESET}"
else
    echo -e "${RED}${BOLD}Failures: ${failures[*]}${RESET}"
    exit 1
fi
